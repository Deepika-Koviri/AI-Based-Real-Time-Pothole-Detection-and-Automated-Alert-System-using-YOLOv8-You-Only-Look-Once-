{% extends "base.html" %}
{% block content %}
<style>
  :root{
    --bg-card: #ffffff;
    --accent: #6eb8e1;
    --accent-soft: #c8abe6;
    --text-main: #1f2933;
    --text-muted: #6b7280;
    --border-subtle: #e5e7eb;
  }

  /* Hide base.html top-right flash toasts on dashboard (we will show modal instead) */
  .flash-container{ display: none !important; }

  .dash-page{
    padding: 14px;
    border-radius: 22px;
    background: linear-gradient(135deg, #d6e6f2 0%, #ffffff 45%, #c8abe6 100%);
    min-height: calc(100vh - 32px);
  }

  .dash-header{
    background: var(--bg-card);
    border-radius: 24px;
    padding: 1.2rem 1.6rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.2rem;
    box-shadow: 0 16px 40px rgba(148, 163, 184, 0.35), 0 0 0 1px rgba(148, 163, 184, 0.3);
    gap: 14px;
    flex-wrap: wrap;
  }

  .dash-title h1{
    margin:0;
    font-size:1.6rem;
    color: var(--text-main);
  }
  .dash-title p{
    margin:0.25rem 0 0;
    font-size:0.85rem;
    color: var(--text-muted);
  }

  .dash-right{
    display:flex;
    align-items:center;
    gap:0.7rem;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .dash-badge{
    padding: 0.3rem 0.8rem;
    border-radius: 999px;
    background: rgba(110, 184, 225, 0.16);
    color: #1d4ed8;
    font-size: 0.78rem;
    white-space: nowrap;
  }

  .btn{
    padding: 0.55rem 1.15rem;
    border-radius: 999px;
    border: 1px solid #d1d5db;
    cursor: pointer;
    font-weight: 700;
    font-size: 0.9rem;
    white-space: nowrap;
    background: #ffffff;
    color: #111827;
    text-decoration: none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
  }

  .btn-primary{
    border: none;
    background: linear-gradient(90deg, var(--accent), var(--accent-soft));
    color: #ffffff;
  }
  .btn-full{ width: 100%; }

  .dash-main{
    display: grid;
    grid-template-columns: 0.95fr 1.05fr;
    gap: 1.4rem;
  }

  .dash-card{
    background: var(--bg-card);
    border-radius: 24px;
    padding: 1.4rem 1.6rem 1.6rem;
    box-shadow: 0 18px 45px rgba(148, 163, 184, 0.35), 0 0 0 1px rgba(148, 163, 184, 0.3);
    min-width: 0;
  }

  .section-label{
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.09em;
    color: var(--text-muted);
    margin-bottom: 0.35rem;
  }

  .card-title{
    margin: 0 0 0.7rem;
    font-size: 1.05rem;
    font-weight: 800;
    color: var(--text-main);
  }

  .guest-note{
    background: #fff7ed;
    border: 1px solid #fed7aa;
    color: #9a3412;
    padding: 10px 12px;
    border-radius: 14px;
    font-size: 0.85rem;
    margin: 0.2rem 0 1rem;
    line-height: 1.35;
  }

  label{
    display:block;
    font-size:0.8rem;
    margin-bottom:0.25rem;
    color: var(--text-muted);
    font-weight: 750;
  }

  input[type="number"], input[type="text"]{
    width: 100%;
    border-radius: 12px;
    border: 1px solid var(--border-subtle);
    padding: 0.55rem 0.75rem;
    background: #f9fafb;
    color: var(--text-main);
    font-size: 0.9rem;
    outline: none;
  }

  input:focus{
    border-color: var(--accent);
    background: #ffffff;
    box-shadow: 0 0 0 1px rgba(110,184,225,0.5);
  }

  .grid-2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.9rem;
    margin-top: 0.35rem;
  }

  .grid-3{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.9rem;
    margin-top: 0.6rem;
    align-items: end;
  }

  .checkbox-row{
    display:flex;
    align-items:center;
    gap:0.45rem;
    margin-top: 1.1rem;
    font-size:0.85rem;
    color: var(--text-muted);
  }

  .checkbox-row input{
    transform: translateY(1px);
  }

  /* Tabs */
  .tab-buttons{
    display:flex;
    gap:0.8rem;
    margin-bottom: 1rem;
    border-bottom: 2px solid var(--border-subtle);
  }

  .tab-btn{
    padding: 0.5rem 1rem;
    border: none;
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    font-weight: 900;
    font-size: 0.85rem;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s ease;
  }

  .tab-btn.active{
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  .tab-content{ display:none; }
  .tab-content.active{ display:block; }

  /* Upload zone */
  .upload-zone{
    border: 2px dashed var(--accent);
    border-radius: 12px;
    padding: 1.4rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: #f9fafb;
    user-select: none;
  }
  .upload-zone:hover{
    background: rgba(110,184,225,0.05);
    border-color: var(--accent-soft);
  }
  .upload-zone.dragover{
    background: rgba(110,184,225,0.10);
    border-color: var(--accent-soft);
  }
  .upload-zone-icon{
    font-size: 2rem;
    margin-bottom: 0.35rem;
  }
  .upload-zone-text{
    font-size: 0.85rem;
    color: var(--text-muted);
    margin: 0;
  }
  .upload-zone-name{
    font-size: 0.8rem;
    color: #2563eb;
    margin-top: 0.5rem;
    font-weight: 800;
  }

  #fileInput{ display:none; }

  /* Camera */
  .video-container{
    width: 100%;
    border-radius: 12px;
    border: 1px solid var(--border-subtle);
    background: #000;
    overflow: hidden;
    margin-bottom: 0.8rem;
  }
  #camera-video{
    width: 100%;
    height: 300px;
    object-fit: cover;
  }
  #camera-canvas{ display:none; }

  .camera-controls{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:0.6rem;
    margin-bottom: 0.6rem;
  }
  .camera-controls button{
    padding: 0.55rem;
    border-radius: 12px;
    border: none;
    background: linear-gradient(90deg, var(--accent), var(--accent-soft));
    color: white;
    cursor: pointer;
    font-weight: 900;
    font-size: 0.82rem;
    transition: all 0.2s ease;
  }
  .camera-controls button:disabled{
    background: #d1d5db;
    cursor:not-allowed;
  }

  .camera-status{
    font-size: 0.78rem;
    color: var(--text-muted);
    text-align:center;
    min-height: 1.2rem;
  }

  /* Location UI */
  .loc-card{
    margin-top: 1.05rem;
    padding-top: 1.05rem;
    border-top: 1px solid var(--border-subtle);
  }
  .loc-hint{
    margin: 0.35rem 0 0.75rem;
    color: var(--text-muted);
    font-size: 0.82rem;
    line-height: 1.35;
  }
  .loc-actions{
    display:flex;
    gap: 0.6rem;
    flex-wrap: wrap;
    margin-top: 0.6rem;
  }
  .loc-actions .btn{
    padding: 0.45rem 0.9rem;
    font-size: 0.82rem;
  }
  .loc-status{
    margin-top: 0.6rem;
    font-size: 0.8rem;
    color: var(--text-muted);
    min-height: 1.2rem;
  }

  /* Results */
  .result-img{
    width: 100%;
    border-radius: 16px;
    margin-top: 0.7rem;
    border: 1px solid var(--border-subtle);
  }

  .result-table{
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82rem;
    margin-top: 0.9rem;
  }
  .result-table th, .result-table td{
    padding: 0.45rem 0.5rem;
    border-bottom: 1px solid #e5e7eb;
    vertical-align: top;
  }
  .result-table th{
    text-align: left;
    color: var(--text-muted);
    font-weight: 900;
  }

  .pill-severity{
    padding: 0.15rem 0.6rem;
    border-radius: 999px;
    font-size: 0.78rem;
    font-weight: 900;
    display: inline-block;
  }
  .pill-severity.Large{ background:#fee2e2; color:#b91c1c; }
  .pill-severity.Medium{ background:#fef3c7; color:#92400e; }
  .pill-severity.Small{ background:#dcfce7; color:#166534; }

  @media (max-width: 1100px){
    .dash-main{ grid-template-columns: 1fr; }
  }

  /* ===== Center Popup Modal (NEW) ===== */
  .pothole-modal-backdrop{
    position: fixed;
    inset: 0;
    background: rgba(17, 24, 39, 0.55);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 18px;
  }

  .pothole-modal-box{
    width: min(520px, 94vw);
    background: #ffffff;
    border-radius: 18px;
    padding: 18px 18px 14px;
    box-shadow: 0 24px 60px rgba(0,0,0,0.25);
    border: 2px solid rgba(110, 184, 225, 0.55);
  }

  .pothole-modal-box.success{ border-color: rgba(34,197,94,0.65); }
  .pothole-modal-box.warning{ border-color: rgba(249,115,22,0.65); }
  .pothole-modal-box.danger{ border-color: rgba(239,68,68,0.65); }
  .pothole-modal-box.info{ border-color: rgba(59,130,246,0.55); }

  .pothole-modal-title{
    margin: 0 0 6px;
    font-size: 1.1rem;
    font-weight: 900;
    color: #111827;
  }

  .pothole-modal-sub{
    margin: 0 0 12px;
    font-size: 0.85rem;
    color: #6b7280;
  }

  .pothole-modal-message{
    margin: 0 0 14px;
    color: #111827;
    line-height: 1.55;
    font-size: 0.95rem;
    white-space: pre-wrap;
  }

  .pothole-modal-actions{
    display: flex;
    justify-content: center;
    gap: 10px;
    padding-top: 6px;
    border-top: 1px solid #e5e7eb;
  }

  .pothole-modal-btn{
    border: none;
    cursor: pointer;
    padding: 10px 22px;
    border-radius: 999px;
    font-weight: 900;
    background: linear-gradient(90deg, var(--accent), var(--accent-soft));
    color: #ffffff;
  }

  .pothole-modal-btn:active{ transform: scale(0.99); }
</style>

<div class="dash-page">
  <header class="dash-header">
    <div class="dash-title">
      <h1>AI-Based Pothole Detection System</h1>
      <p>Real-time road safety & smart monitoring â€¢ Welcome, {{ user_name }}.</p>
    </div>

    <div class="dash-right">
      <span class="dash-badge">Vision â€¢ YOLOv8 â€¢ MiDaS</span>
      {% if user_name == "Guest" %}
        <button type="button" class="btn" onclick="openLoginModal()">Login</button>
      {% else %}
        <a href="{{ url_for('logout') }}" class="btn">Logout</a>
      {% endif %}
    </div>
  </header>

  <main class="dash-main">
    <!-- LEFT: Input + settings -->
    <section class="dash-card">
      <div class="section-label">Upload Road Image</div>
      <h2 class="card-title">Input & cost settings</h2>

      {% if user_name == "Guest" %}
        <div class="guest-note">
          Login is required to run detection. You can still open the popup and login here without leaving the dashboard.
        </div>
      {% endif %}

      <form id="detectForm" method="POST" action="{{ url_for('dashboard') }}" enctype="multipart/form-data">
        <!-- One input_type (important): JS switches between upload/camera -->
        <input type="hidden" name="input_type" id="inputType" value="upload" />

        <div class="tab-buttons">
          <button type="button" class="tab-btn active" data-tab="uploadTab" data-type="upload">Upload Image</button>
          <button type="button" class="tab-btn" data-tab="cameraTab" data-type="camera">Live Camera</button>
        </div>

        <!-- Upload Tab -->
        <div class="tab-content active" id="uploadTab">
          <input type="file" id="fileInput" name="image" accept="image/*" />

          <div class="upload-zone" id="uploadZone">
            <div class="upload-zone-icon">ðŸ“¤</div>
            <p class="upload-zone-text">Drag and drop your image here<br/>or click to select</p>
            <div class="upload-zone-name" id="uploadFileName" style="display:none;"></div>
          </div>
        </div>

        <!-- Camera Tab -->
        <div class="tab-content" id="cameraTab">
          <input type="hidden" name="camera_image" id="cameraImageInput" />

          <div class="video-container">
            <video id="camera-video" autoplay playsinline></video>
            <canvas id="camera-canvas"></canvas>
          </div>

          <div class="camera-controls">
            <button type="button" id="startCamBtn">Start Camera</button>
            <button type="button" id="captureBtn" disabled>Capture</button>
            <button type="button" id="clearCaptureBtn" disabled>Clear</button>
          </div>

          <div class="camera-status" id="cameraStatus">Camera not started.</div>
        </div>

        <!-- Location section (for BOTH upload and camera) -->
        <div class="loc-card">
          <div class="section-label">Location (Address / Coordinates)</div>

          <div class="grid-2">
            <div>
              <label>Address / Place name</label>
              <input type="text" name="location_text" id="addressInput" placeholder="Ex: MVP Colony, Visakhapatnam" />
            </div>
            <div>
              <label>Location status</label>
              <input type="text" id="locStatusBox" value="Enter address or use coordinates." readonly />
            </div>
          </div>

          <div class="grid-2" style="margin-top: 0.85rem;">
            <div>
              <label>Latitude</label>
              <input type="text" name="lat" id="latInput" placeholder="Ex: 17.7310" />
            </div>
            <div>
              <label>Longitude</label>
              <input type="text" name="lon" id="lonInput" placeholder="Ex: 83.2185" />
            </div>
          </div>

          <div class="loc-actions">
            <button type="button" class="btn" id="getLocationBtn">Use current location (GPS)</button>
            <button type="button" class="btn" id="clearLocationBtn">Clear location</button>
          </div>

          <div class="loc-status" id="locStatusText">
            For Live Camera, location can be captured automatically (allow browser location permission).
          </div>
        </div>

        <div class="section-label" style="margin-top: 1.1rem;">Cost configuration (India)</div>

        <div class="grid-2">
          <div>
            <label>Min rate (â‚¹ per mÂ³)</label>
            <input type="number" name="rate_min" value="4000" step="1" min="0" />
          </div>
          <div>
            <label>Max rate (â‚¹ per mÂ³)</label>
            <input type="number" name="rate_max" value="6000" step="1" min="0" />
          </div>
        </div>

        <div class="grid-2" style="margin-top: 0.85rem;">
          <div>
            <label>Max pothole depth (cm)</label>
            <input type="number" name="max_depth_cm" value="10" step="0.1" min="0" />
          </div>
          <div>
            <label>Approx. ground scale (cm / pixel)</label>
            <input type="number" name="pixel_to_cm" value="0.5" step="0.01" min="0" />
          </div>
        </div>

        <div class="checkbox-row">
          <input type="checkbox" id="alertsEnabled" name="alerts_enabled" checked />
          <label for="alertsEnabled" style="margin:0; cursor:pointer;">Enable alerts</label>
        </div>

        {% if user_name == "Guest" %}
          <button type="button" class="btn btn-primary btn-full" onclick="openLoginModal()" style="margin-top: 1rem;">
            Login to Detect potholes
          </button>
        {% else %}
          <!-- Replace your button with this -->
<button type="submit" name="action" value="detect_and_save" class="btn btn-primary btn-full" style="margin-top: 1rem;">
  ðŸš€ Detect & Auto-Save to Recommendations
</button>


        {% endif %}
      </form>
    </section>

    <!-- RIGHT: Results -->
    <section class="dash-card">
      <div class="section-label">Detections</div>
      <h2 class="card-title">Pothole analytics</h2>

      {% if annotated_image %}
        <img class="result-img" src="{{ '/' ~ annotated_image }}" alt="Detection Result" />
      {% else %}
        <p style="margin:0; color: var(--text-muted); font-size: 0.9rem;">
          Upload a road image to visualize detected potholes, severity, and repair estimates.
        </p>
      {% endif %}

      {% if detections %}
        <table class="result-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Conf</th>
              <th>Area (cmÂ²)</th>
              <th>Volume (cmÂ³)</th>
              <th>Severity</th>
              <th>Cost (â‚¹)</th>
              <th>Time (min)</th>
            </tr>
          </thead>
          <tbody>
            {% for d in detections %}
              <tr>
                <td>{{ d.ID }}</td>
                <td>{{ d.Conf }}</td>
                <td>{{ d.Area_cm2 }}</td>
                <td>{{ d.Volume_cm3 }}</td>
                <td><span class="pill-severity {{ d.Severity }}">{{ d.Severity }}</span></td>
                <td>{{ d.Cost_Min }}â€“{{ d.Cost_Max }}</td>
                <td>{{ d.Time_min }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </section>
    </main>

  <!-- ðŸš€ NEW POTHOLE REPORTS UPLOAD SECTION -->
  <!-- ðŸš€ QUICK SAVE TO RECOMMENDATIONS (uses your EXISTING detection!) -->


  <!-- Closes dash-page -->


<!-- ===== Center Popup Modal (NEW) ===== -->
<div id="potholeAlertModal" class="pothole-modal-backdrop" aria-hidden="true">
  <div id="potholeAlertBox" class="pothole-modal-box info" role="dialog" aria-modal="true" aria-labelledby="potholeModalTitle">
    <h3 id="potholeModalTitle" class="pothole-modal-title">Pothole Alert</h3>
    <p class="pothole-modal-sub" id="potholeModalSub">Please review and click OK to continue.</p>
    <div id="potholeAlertMessage" class="pothole-modal-message"></div>
    <div class="pothole-modal-actions">
      <button id="potholeAlertOkBtn" type="button" class="pothole-modal-btn">OK</button>
    </div>
  </div>
</div>

<script>
  // ---------- Tabs ----------
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabContents = document.querySelectorAll(".tab-content");

  const inputType = document.getElementById("inputType");
  const fileInput = document.getElementById("fileInput");
  const cameraImageInput = document.getElementById("cameraImageInput");

  function setMode(mode){
    inputType.value = mode;

    // Require upload file only in upload mode
    if(mode === "upload"){
      fileInput.required = true;
    }else{
      fileInput.required = false;
    }

    // Small UX: if switching to camera, try to get GPS immediately
    if(mode === "camera"){
      autoGetLocationForCamera();
    }
  }

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      tabButtons.forEach(b => b.classList.remove("active"));
      tabContents.forEach(c => c.classList.remove("active"));

      btn.classList.add("active");
      document.getElementById(btn.dataset.tab).classList.add("active");

      setMode(btn.dataset.type);
    });
  });

  // ---------- Upload drag & drop ----------
  const uploadZone = document.getElementById("uploadZone");
  const uploadFileName = document.getElementById("uploadFileName");

  function showFileName(file){
    if(!file) return;
    uploadFileName.style.display = "block";
    uploadFileName.textContent = file.name;
  }

  uploadZone.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", () => {
    if(fileInput.files && fileInput.files[0]) showFileName(fileInput.files[0]);
  });

  ["dragenter","dragover"].forEach(evt => {
    uploadZone.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadZone.classList.add("dragover");
    });
  });

  ["dragleave","drop"].forEach(evt => {
    uploadZone.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadZone.classList.remove("dragover");
    });
  });

  uploadZone.addEventListener("drop", (e) => {
    const dt = e.dataTransfer;
    if(dt && dt.files && dt.files[0]){
      fileInput.files = dt.files;
      showFileName(dt.files[0]);
    }
  });

  // ---------- Location ----------
  const addressInput = document.getElementById("addressInput");
  const latInput = document.getElementById("latInput");
  const lonInput = document.getElementById("lonInput");
  const locStatusText = document.getElementById("locStatusText");
  const locStatusBox = document.getElementById("locStatusBox");

  const getLocationBtn = document.getElementById("getLocationBtn");
  const clearLocationBtn = document.getElementById("clearLocationBtn");

  function setLocStatus(msg){
    locStatusText.textContent = msg;
    locStatusBox.value = msg;
  }

  function clearLocation(){
    addressInput.value = "";
    latInput.value = "";
    lonInput.value = "";
    setLocStatus("Location cleared. Enter address or use coordinates.");
  }

  async function reverseGeocodeOSM(lat, lon){
    // Best-effort (may be rate-limited). If it fails, keep address empty.
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
    try{
      const res = await fetch(url, {
        headers: { "Accept": "application/json" }
      });
      if(!res.ok) return null;
      const data = await res.json();
      return data && data.display_name ? data.display_name : null;
    }catch(e){
      return null;
    }
  }

  async function getCurrentLocation({ fillAddress=true } = {}){
    if(!navigator.geolocation){
      setLocStatus("Geolocation not supported in this browser.");
      return;
    }

    setLocStatus("Getting current locationâ€¦ allow permission.");
    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      latInput.value = lat.toFixed(6);
      lonInput.value = lon.toFixed(6);

      let addr = null;
      if(fillAddress){
        addr = await reverseGeocodeOSM(latInput.value, lonInput.value);
      }
      if(addr && !addressInput.value){
        addressInput.value = addr;
        setLocStatus("Location captured (GPS + address).");
      }else{
        setLocStatus("Location captured (GPS).");
      }
    }, (err) => {
      setLocStatus("Location permission denied or unavailable.");
    }, {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 30000
    });
  }

  function autoGetLocationForCamera(){
    // Only auto-fill if fields are empty
    const hasCoords = (latInput.value.trim() && lonInput.value.trim());
    if(!hasCoords){
      getCurrentLocation({ fillAddress: true });
    }
  }

  getLocationBtn.addEventListener("click", () => getCurrentLocation({ fillAddress: true }));
  clearLocationBtn.addEventListener("click", clearLocation);

  // ---------- Camera capture ----------
  const video = document.getElementById("camera-video");
  const canvas = document.getElementById("camera-canvas");
  const startCamBtn = document.getElementById("startCamBtn");
  const captureBtn = document.getElementById("captureBtn");
  const clearCaptureBtn = document.getElementById("clearCaptureBtn");
  const cameraStatus = document.getElementById("cameraStatus");

  let stream = null;

  startCamBtn.addEventListener("click", async () => {
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      video.srcObject = stream;
      cameraStatus.textContent = "Camera started. Click Capture.";
      captureBtn.disabled = false;
      clearCaptureBtn.disabled = true;
      cameraImageInput.value = "";

      // Auto location when camera starts
      autoGetLocationForCamera();

    }catch(err){
      cameraStatus.textContent = "Camera permission denied or not available.";
      captureBtn.disabled = true;
      clearCaptureBtn.disabled = true;
    }
  });

  captureBtn.addEventListener("click", () => {
    if(!video.videoWidth || !video.videoHeight){
      cameraStatus.textContent = "Camera not ready yet.";
      return;
    }

    // If user is in camera mode but has no coords, try to request location
    if(inputType.value === "camera"){
      const hasCoords = (latInput.value.trim() && lonInput.value.trim());
      if(!hasCoords){
        setLocStatus("Please allow GPS location (or enter coords) before capture.");
        getCurrentLocation({ fillAddress: true });
        return;
      }
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
    cameraImageInput.value = dataUrl;

    cameraStatus.textContent = "Captured. Now click Detect potholes.";
    clearCaptureBtn.disabled = false;
  });

  clearCaptureBtn.addEventListener("click", () => {
    cameraImageInput.value = "";
    cameraStatus.textContent = "Capture cleared.";
    clearCaptureBtn.disabled = true;
  });

  // Stop camera when leaving page
  window.addEventListener("beforeunload", () => {
    if(stream){
      stream.getTracks().forEach(t => t.stop());
    }
  });

  // Initialize default mode
  setMode("upload");

  // ==========================================================
  // =============== Center Popup Alert Queue =================
  // ==========================================================
  const modalEl = document.getElementById("potholeAlertModal");
  const modalBoxEl = document.getElementById("potholeAlertBox");
  const modalMsgEl = document.getElementById("potholeAlertMessage");
  const modalOkBtn = document.getElementById("potholeAlertOkBtn");

  const alertQueue = [];
  let isAlertShowing = false;

  function normalizeType(t){
    const ok = ["success","warning","danger","info"];
    return ok.includes(t) ? t : "info";
  }

  function enqueuePotholeAlert(message, type="info"){
    alertQueue.push({
      message: String(message || "").trim(),
      type: normalizeType(type)
    });
    showNextAlert();
  }

  function showNextAlert(){
    if(isAlertShowing) return;
    if(alertQueue.length === 0){
      modalEl.style.display = "none";
      modalEl.setAttribute("aria-hidden", "true");
      return;
    }

    const item = alertQueue.shift();
    modalMsgEl.textContent = item.message;

    modalBoxEl.classList.remove("success","warning","danger","info");
    modalBoxEl.classList.add(item.type);

    modalEl.style.display = "flex";
    modalEl.setAttribute("aria-hidden", "false");
    isAlertShowing = true;

    // Keep focus on OK for accessibility
    setTimeout(() => modalOkBtn.focus(), 0);
  }

  modalOkBtn.addEventListener("click", () => {
    // Close current alert, then immediately show next if available
    isAlertShowing = false;
    modalEl.style.display = "none";
    modalEl.setAttribute("aria-hidden", "true");
    showNextAlert();
  });

  // Prevent closing modal by clicking backdrop (as you requested: only OK should close)
  modalEl.addEventListener("click", (e) => {
    if(e.target === modalEl){
      // do nothing
    }
  });

  // ==========================================================
  // ===== Build alerts from detections + Flask flash msgs =====
  // ==========================================================
  document.addEventListener("DOMContentLoaded", () => {
    const enabled = document.getElementById("alertsEnabled") ? document.getElementById("alertsEnabled").checked : true;
    if(!enabled) return;

    // 1) Create one popup per pothole detection (server-rendered table)
    const detectionAlerts = [
      {% if detections %}
        {% for d in detections %}
          {
            message: "Pothole {{ d.ID }} detected ({{ d.Severity }}).\\nArea: {{ d.Area_cm2 }} cmÂ²\\nVolume: {{ d.Volume_cm3 }} cmÂ³\\nCost: â‚¹{{ d.Cost_Min }}â€“â‚¹{{ d.Cost_Max }}\\nTime: {{ d.Time_min }} min",
            type: "{{ 'danger' if d.Severity == 'Large' else 'warning' if d.Severity == 'Medium' else 'success' }}"
          }{% if not loop.last %},{% endif %}
        {% endfor %}
      {% endif %}
    ];

    detectionAlerts.forEach(a => enqueuePotholeAlert(a.message, a.type));

    // 2) Also convert Flask flash messages (from base.html) into modal popups
    // base.html renders: <div class="flash-container"> <div class="flash {{category}}">message</div>...</div>
    const flashEls = document.querySelectorAll(".flash-container .flash");
    flashEls.forEach(el => {
      const msg = (el.textContent || "").trim();
      if(!msg) return;

      const classes = Array.from(el.classList);
      let type = "info";
      if(classes.includes("danger")) type = "danger";
      else if(classes.includes("warning")) type = "warning";
      else if(classes.includes("success")) type = "success";
      else if(classes.includes("info")) type = "info";

      enqueuePotholeAlert(msg, type);
    });

    // Optional: if there are no detection alerts and no flash, do nothing (no popup).
  });

  // ðŸš€ NEW: Pothole Reports Upload (connects to /recommendations table)
// ðŸš€ Save current detection to recommendations table


</script>
{% endblock %}
